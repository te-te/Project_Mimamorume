/*! 
 * PLAYRTC. PLAYRTC is WebRTC SDK.
 * Copyright 2013, 2017 Lee Jun
 * 
 * project: PLAYRTC
 * version: 2.2.21
 * contact: jun@bluedigm.com
 * homepage: http://www.playrtc.com
 * Date: 2017-07-20 17:20 
 */
!function(a){var b=a();"object"==typeof module&&"object"==typeof module.exports?module.exports=b:window.PlayRTC=b}(function(){function request(a){Logger.trace("cdm",{klass:"Core",method:"request",message:"Called http request. options = "+JSON.stringify(a)});var b=new XMLHttpRequest;b.onreadystatechange=function(b){var c=b.target,d=c.responseText;if(4===c.readyState&&200===c.status&&d)try{Logger.trace("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+d}),d=JSON.parse(d),d.error?a.error&&a.error(c,d):a.success&&a.success(d)}catch(b){Logger.error("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+c.responseText}),a.error&&a.error(c,d)}else if(4===c.readyState&&200!==c.status)try{d=JSON.parse(d),a.error(c,d)}catch(b){Logger.error("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+c.responseText}),a.error(c)}},b.open(a.method,a.url,!0),a.contentType?b.setRequestHeader("Content-Type",a.contentType):("firefox"===utils.browser.name&&b.setRequestHeader("Accept","application/json"),b.setRequestHeader("Content-Type","application/json; charset=UTF-8")),a.url.indexOf("https://apis.sktelecom.com/v3/playrtc")!==-1?a.projectKey&&b.setRequestHeader("TDCProjectKey",a.projectKey):(a.TDCProjectId&&b.setRequestHeader("TDCProjectId",a.TDCProjectId),a.TDCLicense&&b.setRequestHeader("TDCLicense",a.TDCLicense)),a.body?b.send(JSON.stringify(a.body)):b.send()}function errorDelegate(a,b,c){var d=null,e=null;switch(b){case"40102":case"40103":d="C4004",e=SDK_ERROR_CODE.C4004;break;case"40104":d="C4005",e=SDK_ERROR_CODE.C4005;break;default:d="C4006",e=SDK_ERROR_CODE.C4006}this.fire("error",d,e,c)}function _call(a,b){if(!UserMedia)return Logger.error("cdm",{method:"_call",message:"Your device is not supported media"}),this.error("M4001",SDK_ERROR_CODE.M4001),!1;var c=this.userMedia;c.video||c.audio?this.getMedia()||UserMedia.call(navigator,c,utils.bind(function(b){if(Logger.trace("cdm",{klass:"PlayRTC",method:"createUserMedia",message:"Got local stream. constraints = "+JSON.stringify(c)}),this.hasEvent("addLocalStream")){if(this.fire("addLocalStream",b)===!1&&this.config.localMediaTarget){var d=document.getElementById(this.config.localMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.setAttribute("muted",!0),d.src=utils.createObjectURL(b))}}else if(this.config.localMediaTarget){var d=document.getElementById(this.config.localMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.setAttribute("muted",!0),d.src=utils.createObjectURL(b))}this.createMedia(b),a.call(this),"function"==typeof utils.mediaRecorderSupport&&utils.mediaRecorderSupport(b)},this),utils.bind(function(a){Logger.error("cdm",{klass:"PlayRTC",method:"createUserMedia",message:"Failed to get local stream. message = "+a.message}),this.destroy();var b=a.name.toUpperCase();"PERMISSIONDENIEDERROR"===b||"SECURITYERROR"===b?this.error("M4002",SDK_ERROR_CODE.M4002,a):"DEVICESNOTFOUNDERROR"===b||"NOTFOUNDERROR"===b?this.error("M4003",SDK_ERROR_CODE.M4003,a):this.error("M4004",SDK_ERROR_CODE.M4004,a)},this)):this.dataChannelEnabled?a.call(this):b.call(this)}var PeerConnection=function(){var a=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.RTCPeerConnection;return a}(),NativeRTCSessionDescription=function(){var a=window.mozRTCSessionDescription||window.RTCSessionDescription;return a}(),NativeRTCIceCandidate=function(){var a=window.mozRTCIceCandidate||window.RTCIceCandidate;return a}(),UserMedia=function(){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a}(),URL=function(){var a=window.URL||window.webkitURL||window.msURL||window.oURL;return a}(),utils={};utils.browser=function(){function a(a){var c=b.match(a);return c&&c.length>1&&c[1]||""}var b=navigator.userAgent,c=a(/version\/(\d+(\.\d+)?)/i),d=null;return/chrome|crios|crmo/i.test(b)?d={name:"chrome",version:a(/(?:chrome|crios|crmo)\/([\.1234567890]+)/i)}:/opera|opr/i.test(b)?d={name:"opera",version:c||a(/(?:opera|opr)[\s\/]([\.1234567890]+)/i)}:/msie|trident/i.test(b)?d={name:"ie",version:a(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(b)?d={name:"firefox",version:a(/(?:firefox|iceweasel)[ \/]([\.1234567890]+)/i)}:/safari/i.test(b)&&(d={name:"safari",version:c}),d}(),utils.platform=function(){var a=navigator.userAgent.toLowerCase(),b=navigator.platform,c=/iPhone/i.test(b),d=/iPad/i.test(b),e=/iPod/i.test(b),f=/win/i.test(b),g=/mac/i.test(b),h=/linux/i.test(b),i=c||d||e,j=/android/i.test(a);return f?"windows":i?"ios":j?"android":g?"mac":h?"linux":void 0}(),utils.language=function(){return navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage}(),utils.nation=function(){return utils.language.split("-")[1]}(),utils.Extend=function(a,b){var c=function(){var a=Array.prototype.slice.call(arguments);this.initialize.apply(this,a)},d=function(){},e=a.prototype;if(d.prototype=e,c.prototype=new d,c.prototype.constructor=c,c.base=e,b)for(var f in b)c.prototype[f]=b[f];return c.Extend=function(a){var b=this;return utils.Extend(b,a)},c};var BaseKlass=function(){};utils.Event=utils.Extend(BaseKlass,{initialize:function(){this.listeners={}},on:function(a,b,c){this.listeners||(this.listeners={});var d=this.listeners[a]||(this.listeners[a]=[]);return d.push({callback:b,context:c}),this},off:function(a,b,c){var d,e,f,g,h;if(!a&&!b&&!c)return this.listeners=void 0,this;if(f=this.listeners[a]){if(this.listeners[a]=d=[],b||c)for(g=0,h=f.length;g<h;g++)e=f[g],(b&&b!==e.callback||c&&c!==e.context)&&d.push(e);d.length||delete this.listeners[a]}return this},fire:function(a){if(!this.listeners)return this;var b=Array.prototype.slice.call(arguments,1),c=this.listeners[a],d=-1;if(c){var e=c.length;switch(b.length){case 0:if(1===e)return(ev=c[0]).callback.call(ev.context);for(;++d<e;)(ev=c[d]).callback.call(ev.context);return this;default:if(1===e)return(ev=c[0]).callback.apply(ev.context,b);for(;++d<e;)(ev=c[d]).callback.apply(ev.context,b);return this}}return this},clear:function(){this.listeners={}},hasEvent:function(a){return!!this.listeners[a]}}),utils.apply=function(a,b){if(!a||!b)throw new Error("Failed to execute 'apply' on 'utils': 2 arguments required, but only "+arguments.length+" present.");if("object"==typeof b&&("number"==typeof a||"boolean"==typeof a||"string"==typeof a))return a=b;var c=null;for(c in b)"object"==typeof b[c]&&b[c]&&!b[c].hasOwnProperty("length")?a[c]=utils.apply(a[c]||{},b[c]):a[c]=b[c];return a},utils.bind=function(a,b){if(!a||!b)throw new Error("Failed to execute 'bind' on 'utils': 2 arguments required, but only "+arguments.length+" present.");return function(){a.apply(b,Array.prototype.slice.call(arguments))}},utils.fileDownload=function(a,b){var c=document,d=c.createElementNS("http://www.w3.org/1999/xhtml","a"),e=c.createEvent("MouseEvents");d.href=URL.createObjectURL(a),d.download=b,e.initEvent("click",!0,!1),d.dispatchEvent(e)},utils.createVideo=function(a,b){var c={autoPlay:!0,controls:!0,width:"100%",height:"100%"},d=document.createElement("video");return b=b||{},c=utils.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.setAttribute("width",c.width),d.setAttribute("height",c.height),d.src=utils.createObjectURL(a),d},utils.createAudio=function(a,b){var c={autoPlay:!0,controls:!0},d=document.createElement("audio");return b=b||{},c=utils.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.src=utils.createObjectURL(a),d},utils.createObjectURL=function(a){return URL.createObjectURL(a)},utils.blobWorkerSupport=function(){try{var a=function(a){}.toString(),b=new Blob(["this.onmessage = "+a],{type:"application/javascript"});b=URL.createObjectURL(b);new Worker(b);return URL.revokeObjectURL(b),!0}catch(a){return!1}}(),utils.mediaRecorderSupport=function(a){try{new MediaRecorder(a),utils.mediaRecorderSupport=!0}catch(a){utils.mediaRecorderSupport=!1}},utils.userMediaSupport=!!UserMedia||!1,utils.exportLog=function(){Logger.db.exportLog()},utils.debugViewShow=function(){Logger.monitor.show()},utils.debugViewHide=function(){Logger.monitor.hide()},utils.strFormat=function(a){for(var b=arguments,c=b.length,d=null,e=0;e<c;e++)d=new RegExp("\\{"+e+"\\}","g"),a=a.replace(d,b[e+1]);return a},utils.versionCompare=function(a,b,c){if(typeof a+typeof b!="stringstring")return!1;for(var d=a.split("."),e=b.split("."),f=0,g=Math.max(d.length,e.length);f<g;f++){if(d[f]&&!e[f]&&parseInt(d[f])>0||parseInt(d[f])>parseInt(e[f]))return 1;if(e[f]&&!d[f]&&parseInt(e[f])>0||parseInt(d[f])<parseInt(e[f]))return-1}return 0};var SDK_ERROR_CODE={M4001:"Unsupported media",M4002:"Permission denied",M4003:"Devices not found",M4004:"Unknown media error",C4001:"Failed allocate channel",C4002:"Failed to connect channel's server",C4003:"Already disconnected channel's server",C4004:"Invalid authentication of channel",C4005:"Invalid channel id",C4006:"Channel error",C4007:"Channel's socket error",C4008:"Failed to create sdp",C4009:"Failed to register sdp",C4010:"Failed to register candidate",C4011:"Failed to request nag's ice servers",C4012:"server timeout",P4001:"Failed P2P"},SERVER_CODE={20001:"SUCCESS",40001:"MESSAGE_SYNTAX_ERROR",40101:"PROJECTID_INVALID",40102:"TOKEN_INVALID",40103:"TOKEN_EXPIRED",40104:"CHANNELID_INVALID",40105:"PEERID_INVALID",40106:"UNKNOWN_CONNECTION",40107:"UNKNOWN_COMMAND"},PLATFORM_VERSION={ios:"2.2.8",android:"2.2.9",windows:"2.2.17",mac:"2.2.17",linux:"2.2.17"},Socket=utils.Extend(utils.Event,{initialize:function(a){Socket.base.initialize.call(this),this.socket=new WebSocket(a),this.setEvent()},setEvent:function(){this.socket.onopen=utils.bind(function(a){this.fire("open",a)},this),this.socket.onclose=utils.bind(function(a){this.fire("close",a)},this),this.socket.onerror=utils.bind(function(a){this.fire("error",a)},this),this.socket.onmessage=utils.bind(function(a){this.fire("message",a)},this)},send:function(a){try{this.socket.send(a)}catch(a){}},getReadyState:function(){return this.socket.readyState},close:function(){this.socket&&this.socket.close()}}),PlayRTC=utils.Extend(utils.Event,{initialize:function(a){if(!a.projectKey)return void Logger.error("cdm",{klass:"PlayRTC",method:"initialize",message:"Failed to execute 'initialize' on 'PlayRTC': projectKey required, not present"});if(Logger.trace("cdm",{klass:"PlayRTC",method:"initialize",message:"Created instance of 'PlayRTC'"}),this.config={projectKey:null,ring:!1,iceServers:null,localVideoTarget:null,remoteVideoTarget:null,localMediaTarget:null,remoteMediaTarget:null,dataChannelEnabled:!0,logLevel:"TRACE",userMedia:{audio:!0,video:!0},video:!0,audio:!0,data:!0,bandwidth:{video:1500,data:1638400},preferCodec:{audio:"opus",video:"H264"},onlyTurn:!1},this.changelayout_interval=null,this.iceServers=[],this.media=null,this.userMedia={audio:this.config.userMedia.audio,video:this.config.userMedia.video},this.dataChannelEnabled=this.config.dataChannelEnabled,PlayRTC.base.initialize.call(this),utils.apply(this.config,a),a.hasOwnProperty("video")&&(this.userMedia.video=a.video),a.hasOwnProperty("audio")&&(this.userMedia.audio=a.audio),a.hasOwnProperty("data")&&(this.dataChannelEnabled=a.data),"firefox"===PlayRTC.utils.browser.name)"boolean"!=typeof this.userMedia.audio&&(this.userMedia.audio=!0);else if("boolean"!=typeof this.userMedia.audio){var b={optional:[{googEchoCancellation:!0},{googAutoGainControl:!0},{googNoiseReduction:!0},{googNoiseSuppression:!0},{googHighpassFilter:!0}],mandatory:{}};this.userMedia.audio.hasOwnProperty("echoCancellation")&&(b.optional[0].googEchoCancellation=this.userMedia.audio.echoCancellation),this.userMedia.audio.hasOwnProperty("autoGainControl")&&(b.optional[1].googAutoGainControl=this.userMedia.audio.autoGainControl),this.userMedia.audio.hasOwnProperty("noiseReduction")&&(b.optional[2].googNoiseReduction=this.userMedia.audio.noiseReduction),this.userMedia.audio.hasOwnProperty("noiseSuppression")&&(b.optional[3].googNoiseSuppression=this.userMedia.audio.noiseSuppression),this.userMedia.audio.hasOwnProperty("highpassFilter")&&(b.optional[4].googHighpassFilter=this.userMedia.audio.highpassFilter),this.userMedia.audio=b}if("firefox"===PlayRTC.utils.browser.name){if("boolean"!=typeof this.userMedia.video){var c={};this.userMedia.video.hasOwnProperty("minWidth")&&(c.width?c.width.min=this.userMedia.video.minWidth:c.width={min:this.userMedia.video.minWidth}),this.userMedia.video.hasOwnProperty("minHeight")&&(c.height?c.height.min=this.userMedia.video.minHeight:c.height={min:this.userMedia.video.minHeight}),this.userMedia.video.hasOwnProperty("maxWidth")&&(c.width?c.width.max=this.userMedia.video.maxWidth:c.width={max:this.userMedia.video.maxWidth}),this.userMedia.video.hasOwnProperty("maxHeight")&&(c.height?c.height.max=this.userMedia.video.maxHeight:c.height={max:this.userMedia.video.maxHeight}),this.userMedia.video.hasOwnProperty("minFrameRate")&&(c.frameRate?c.frameRate.min=this.userMedia.video.minFrameRate:c.frameRate={min:this.userMedia.video.minFrameRate}),this.userMedia.video.hasOwnProperty("maxFrameRate")&&(c.frameRate?c.frameRate.max=this.userMedia.video.maxFrameRate:c.frameRate={max:this.userMedia.video.maxFrameRate}),this.userMedia.video=c}}else if("boolean"!=typeof this.userMedia.video){var c={optional:[],mandatory:{}};this.userMedia.video.hasOwnProperty("minWidth")&&(c.mandatory.minWidth=this.userMedia.video.minWidth),this.userMedia.video.hasOwnProperty("minHeight")&&(c.mandatory.minHeight=this.userMedia.video.minHeight),this.userMedia.video.hasOwnProperty("maxWidth")&&(c.mandatory.maxWidth=this.userMedia.video.maxWidth),this.userMedia.video.hasOwnProperty("maxHeight")&&(c.mandatory.maxHeight=this.userMedia.video.maxHeight),this.userMedia.video.hasOwnProperty("minFrameRate")&&(c.mandatory.minFrameRate=this.userMedia.video.minFrameRate),this.userMedia.video.hasOwnProperty("maxFrameRate")&&(c.mandatory.maxFrameRate=this.userMedia.video.maxFrameRate),this.userMedia.video=c}return Rest.setProjectKey(this.config.projectKey),this.config.logLevel=this.config.logLevel.toUpperCase(),Logger.setLogLevel(this.config.logLevel),this.config.localVideoTarget&&(this.config.localMediaTarget=this.config.localVideoTarget),this.config.remoteVideoTarget&&(this.config.remoteMediaTarget=this.config.remoteVideoTarget),this.userMedia.audio||this.userMedia.video||this.dataChannelEnabled?void 0:void Logger.error("cdm",{klass:"PlayRTC",method:"initialize",message:"Might be true one of video or audio or dataChannel"})},_setServers:function(a,b,c){var d=null;d=this.config.iceServers?this.config.iceServers:[{url:"turn:"+c.turnserver.turnIp+":"+c.turnserver.turnPort,credential:c.turnserver.turnPw,username:c.turnserver.turnId}],this.nagToken=b,this.iceServers=d,this.channelServer=a.channelUrl,this.nagServer=a.nagRestUrl,this.fractionLost=a.fractionLost,Logger.trace("cdm",{klass:"PlayRTC",method:"_setServers",message:"Set servers channelServer["+this.channelServer+"] nagServer["+this.nagServer+"] iceServers["+JSON.stringify(this.iceServers)+"]"})},_createCall:function(a,b,c){this.calling=new Call(this,{nagToken:this.nagToken,token:a,channelId:b,uid:c}),this.calling.on("addRemoteStream",this.addRemoteStream,this).on("_disconnectChannel",this._disconnectChannel,this).on("_otherDisconnectChannel",this._otherDisconnectChannel,this).on("stateChange",this._stateChange,this).on("error",this.error,this).on("userCommand",this.onUserCommand,this)},createChannel:function(a){return this.calling?void Logger.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Already connected channel"}):(this.create_flag=1,a=a||{},a.env={os:utils.platform,device:utils.browser.name,version:"",carrier:"",country:utils.nation,networkType:"wired"},Logger.trace("cdm",{klass:"PlayRTC",method:"createChannel",message:"Called createChannel. data = "+JSON.stringify(a)}),void _call.call(this,function(){Rest.createChannel(a,utils.bind(function(b){this.channelType=b.channelType;var c=b.channelId,d=b.token.tokenId,e=b.configuration,f=a.peer?a.peer.uid||"":"";this._setServers(e,b.nag.data.authToken,b.turn),this._createCall(d,c,f),this.fire("connectChannel",c,"create")},this),utils.bind(function(a,b){this.destroy(),Logger.trace("cdmn",{klass:"PlayRTC",method:"createChannel",type:"p2p",callType:"caller",resultCode:"300",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.userMedia.audio?"Y":"N",videoYn:this.userMedia.video?"Y":"N",message:"Status["+a.status+"] Failed createChannel. data = "+JSON.stringify(b)}),this.error("C4001",SDK_ERROR_CODE.C4001,b)},this))},function(){Logger.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Must set 'true' video or audio or data"})}))},connectChannel:function(a,b){return this.calling?void Logger.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Already connected channel"}):a?(this.create_flag=0,b=b||{},b.env={os:utils.platform,device:utils.browser.name,version:"",carrier:"",country:utils.nation,networkType:"wired"},Logger.trace("cdm",{klass:"PlayRTC",method:"connectChannel",channelId:a,message:"Called connectChannel. data = "+JSON.stringify(b)}),void _call.call(this,function(){Rest.connectChannel(a,b,utils.bind(function(a){this.channelType=a.channelType;var c=a.channelId,d=a.token.tokenId,e=a.configuration,f=b.peer?b.peer.uid||"":"";this._setServers(e,a.nag.data.authToken,a.turn),this._createCall(d,c,f),this.fire("connectChannel",c,"connect")},this),utils.bind(function(a,b){this.destroy(),Logger.trace("cdmn",{klass:"PlayRTC",method:"connectChannel",type:"p2p",callType:"callee",resultCode:"300",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.userMedia.audio?"Y":"N",videoYn:this.userMedia.video?"Y":"N",message:"Status["+a.status+"] Failed connectChannel. data = "+JSON.stringify(b)}),this.error("C4001",SDK_ERROR_CODE.C4001,b)},this))},function(){Logger.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Must set 'true' video or audio or data"})})):void Logger.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Failed to execute 'connectChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},disconnectChannel:function(a){this.calling&&(Logger.trace("cdm",{klass:"PlayRTC",method:"disconnectChannel",channelId:this.getChannelId(),message:"Called disconnectChannel"}),a=a||this.getPeerId(),this.calling.channeling.disconnectChannel(a),window.setTimeout(utils.bind(function(){if(a===this.getPeerId()&&this.calling){Logger.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Force disconnectChannel"});var b=this.getChannelId();this.destroy(),this.fire("disconnectChannel",b,a)}},this),2e3))},deleteChannel:function(){this.calling&&(Logger.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Called deleteChannel"}),this.calling.channeling.deleteChannel(),window.setTimeout(utils.bind(function(){if(this.calling){Logger.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Force deleteChannel"});var a=this.getChannelId(),b=this.getPeerId();this.destroy(),this.fire("disconnectChannel",a,b)}},this),2e3))},getChannelList:function(a,b){Logger.trace("cdm",{klass:"PlayRTC",method:"getChannelList",message:"Called getChannelList"}),Rest.getChannelList(utils.bind(function(b){a&&a(b)},this),utils.bind(function(a,c){Logger.error("cdm",{klass:"PlayRTC",method:"getChannelList",message:"Status["+a.status+"] Failed getChannelList. data = "+JSON.stringify(c)}),b&&b(a,c)},this))},getChannel:function(a,b,c){return a?(Logger.trace("cdm",{klass:"PlayRTC",method:"getChannel",message:"Called getChannel"}),void Rest.getChannel(a,utils.bind(function(a){b&&b(a)},this),utils.bind(function(a,b){Logger.error("cdm",{klass:"PlayRTC",method:"getChannel",message:"Status["+a.status+"] Failed getChannel. data = "+JSON.stringify(b)}),c&&c(a,b)},this))):void Logger.error("cdm",{klass:"PlayRTC",method:"getChannel",message:"Failed to execute 'getChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeerList:function(a,b,c){return a?(Logger.trace("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Called getPeerList"}),void Rest.getPeerList(a,utils.bind(function(a){b&&b(a)},this),utils.bind(function(a,b){Logger.error("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Status["+a.status+"] Failed getPeerList. data = "+JSON.stringify(b)}),c&&c(a,b)},this))):void Logger.error("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Failed to execute 'getPeerList' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeer:function(a,b,c,d){return a&&b?(Logger.trace("cdm",{klass:"PlayRTC",method:"getPeer",message:"Called getPeer"}),void Rest.getPeer(a,b,utils.bind(function(a){c&&c(a)},this),utils.bind(function(a,b){Logger.error("cdm",{klass:"PlayRTC",method:"getPeer",message:"Status["+a.status+"] Failed getPeer. data = "+JSON.stringify(b)}),d&&d(a,b)},this))):void Logger.error("cdm",{klass:"PlayRTC",method:"getPeer",message:"Failed to execute 'getPeer' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},searchChannel:function(a,b,c,d){return a&&b?(Logger.trace("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Called searchChannel"}),void Rest.searchChannel(a,b,utils.bind(function(a){c&&c(a)},this),utils.bind(function(a,b){Logger.error("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Status["+a.status+"] Failed searchChannel. data = "+JSON.stringify(b)}),d&&d(a,b)},this))):void Logger.error("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Failed to execute 'searchChannel' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},getPeerByPeerId:function(a){if(!this.calling)return null;var b=this.calling.peers[a];return b?b.peer:null},getPeerByUserId:function(a){if(!this.calling)return null;var b=null,c=this.calling.peers;for(b in c)if(c[b].uid===a)return c[b].peer;return null},getAllPeer:function(){if(!this.calling)return null;var a=this.calling.peers,b=[],c=null;for(c in a)b.push(a[c].peer);return b},getPeerId:function(){return this.calling?this.calling.getToken():null},getChannelId:function(){return this.calling?this.calling.getChannelId():null},addRemoteStream:function(a,b,c){if(this.hasEvent("addRemoteStream")){if(this.fire("addRemoteStream",a,b,c)===!1&&this.config.remoteMediaTarget){var d=document.getElementById(this.config.remoteMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=utils.createObjectURL(c))}}else if(this.config.remoteMediaTarget){var d=document.getElementById(this.config.remoteMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=utils.createObjectURL(c))}},createMedia:function(a){return this.media=new Media(a),this.media},getMedia:function(){return this.media},getConfig:function(){return this.config},dataSend:function(){if(Logger.warn("cdm",{klass:"PlayRTC",method:"dataSend",message:"dataSend is deprecated. please use get sendText of sendFile"}),!this.calling)return!1;if(arguments.length<1)return!1;var a=null,b=null,c=0,d=0,e=null,f=arguments,g=f[0],h=null,i=null,j=null;if(Logger.trace("cdm",{klass:"PlayRTC",method:"dataSend",channelId:this.getChannelId(),message:"Sent data. data = "+g}),"string"==typeof f[1]?(h=f[1],3===f.length?i=f[2]:4===f.length&&(i=f[2],j=f[3])):"function"==typeof f[1]&&(i=f[1],3===f.length&&(j=f[2])),h){if(a=this.getPeerByPeerId(h)||this.getPeerByUserId(h))return e=a.getDataChannel(),void(e&&e.send(g,i,j))}else if(!this.channelType||"broadcast"!==this.channelType&&"composite"!==this.channelType)for(b=this.getAllPeer(),d=b.length;c<d;c++)e=b[c].getDataChannel(),e&&e.send(g,i,j);else if(a=this.getPeerByPeerId("PIDMCU")||this.getPeerByUserId("PIDMCU"))return e=a.getDataChannel(),void(e&&e.send(g,i,j))},_dataSend:function(){if(!this.calling)return!1;if(arguments.length<1)return!1;var a=null,b=null,c=0,d=0,e=null,f=arguments,g=f[0],h=null,i=null,j=null;if(Logger.trace("cdm",{klass:"PlayRTC",method:"dataSend",channelId:this.getChannelId(),message:"Sent data. data = "+g}),"string"==typeof f[1]?(h=f[1],3===f.length?i=f[2]:4===f.length&&(i=f[2],j=f[3])):"function"==typeof f[1]&&(i=f[1],3===f.length&&(j=f[2])),h){if(a=this.getPeerByPeerId(h)||this.getPeerByUserId(h))return e=a.getDataChannel(),void(e&&e.send(g,i,j))}else if(!this.channelType||"broadcast"!==this.channelType&&"composite"!==this.channelType)for(b=this.getAllPeer(),d=b.length;c<d;c++)e=b[c].getDataChannel(),e&&e.send(g,i,j);else if(a=this.getPeerByPeerId("PIDMCU")||this.getPeerByUserId("PIDMCU"))return e=a.getDataChannel(),void(e&&e.send(g,i,j))},sendText:function(){return!!this.calling&&(!(arguments.length<1)&&(Logger.trace("cdm",{klass:"PlayRTC",method:"sendText",channelId:this.getChannelId(),message:"Sent data. data = "+arguments[0]}),void this._dataSend.apply(this,Array.prototype.slice.call(arguments))))},sendFile:function(){return!!this.calling&&(!(arguments.length<1)&&(Logger.trace("cdm",{klass:"PlayRTC",method:"sendFile",channelId:this.getChannelId(),message:"Sent data. data = "+arguments[0]}),void this._dataSend.apply(this,Array.prototype.slice.call(arguments))))},userCommand:function(a,b){if(!this.calling)return!1;Logger.trace("cdm",{klass:"PlayRTC",method:"userCommand",channelId:this.getChannelId(),message:"Sent data. data = "+a});var c=null;b?(c=this.getPeerByPeerId(b)||this.getPeerByUserId(b),c&&this.calling.channeling.userCommand(a,[{id:c.id}])):this.calling.channeling.userCommand(a,[])},onUserCommand:function(a,b){var c=this.getPeerByPeerId(a);c&&this.fire("userCommand",a,c.uid,b)},_disconnectChannel:function(a,b){this.destroy(),this.fire("disconnectChannel",a,b)},_otherDisconnectChannel:function(a,b){if(!this.channelType||"broadcast"!==this.channelType&&"composite"!==this.channelType){var c=document.getElementById(this.config.remoteMediaTarget);c&&(c.src="")}else;this.fire("otherDisconnectChannel",a,b)},error:function(a,b,c){this.disconnectChannel(),this.fire("error",a,b,c)},_stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},destroy:function(){if(this.calling){Logger.trace("cdm",{klass:"PlayRTC",method:"destroy",message:"Destroyed instance of 'PlayRTC'"}),this.calling.destroy(),this.calling=null;var a=document.getElementById(this.config.remoteMediaTarget);a&&(a.src="");var b=document.getElementById(this.config.localMediaTarget);b&&(b.src="")}this.media&&(this.media.stop(),this.media=null)},close:function(){this.destroy()},accept:function(a){this.calling&&this.calling.accept(a)},reject:function(a){this.calling&&this.calling.reject(a)},startStatsReport:function(a,b,c){var d=this.getPeerByPeerId(a);return!!d&&(d.startStatsReport(b,c),!0)},stopStatsReport:function(a){var b=this.getPeerByPeerId(a);return!!b&&(b.stopStatsReport(),!0)},changeLayoutType:function(a){null===this.changelayout_interval&&(this.calling.channeling.changeLayoutType(a),this.changelayout_interval=window.setInterval(utils.bind(function(){window.clearInterval(this.changelayout_interval),this.changelayout_interval=null},this),3e3))}}),Logger=function(){var a=utils.Extend(BaseKlass,{initialize:function(){},trace:function(){},warn:function(){},error:function(){},dateFormat:function(a){var b=a.getFullYear().toString(),c=(a.getMonth()+1).toString(),d=a.getDate().toString(),e=a.getHours().toString(),f=a.getMinutes().toString(),g=a.getSeconds().toString(),h=a.getMilliseconds();return utils.strFormat("{0}/{1}/{2} {3}:{4}:{5}.{6}",b,function(){return c[1]?c:"0"+c[0]},function(){return d[1]?d:"0"+d[0]},function(){return e[1]?e:"0"+e[0]},function(){return f[1]?f:"0"+f[0]},function(){return g[1]?g:"0"+g[0]},function(){return h<10?h="00"+h:h<100&&(h="0"+h),h})}}),b=function(b,c){var d,e=null;return PlayRTC.loggers[b]?e=PlayRTC.loggers[b]:(d=utils.Extend(a,c),e=PlayRTC.loggers[b]=new d),e};return PlayRTC.loggers={},{level:0,LOGLEVEL:{TRACE:0,WARN:1,ERROR:2,NONE:3},typeEach:function(a,b){for(var c=null,d=a.length,e=null;d--;){switch(c=a[d].toUpperCase()){case"C":e=Logger.console;break;case"N":e=Logger.network;break;case"D":e=Logger.db;break;case"M":e=Logger.monitor}e&&b.call(e),e=null}},trace:function(a,b){this.LOGLEVEL.TRACE<this.level||(b.logType="TRACE",this.typeEach(a,function(){this.trace(b)}))},warn:function(a,b){this.LOGLEVEL.WARN<this.level||(b.logType="WARN",this.typeEach(a,function(){this.warn(b)}))},error:function(a,b){this.LOGLEVEL.ERROR<this.level||(b.logType="ERROR",this.typeEach(a,function(){this.error(b)}))},setLogLevel:function(a){this.level=this.LOGLEVEL[a],this.level||(this.level=0)},console:b("console",{initialize:function(){this.console=window.console,this.debugFn=this.console.debug?"debug":"log"},trace:function(a){this.console[this.debugFn](this.format(a))},warn:function(a){this.console.warn(this.format(a))},error:function(a){this.console.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return utils.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),monitor:b("monitor",{initialize:function(){function a(){}this.view={setLog:a,show:a,hide:a,exportLog:a,trace:a,error:a,warn:a}},show:function(){this.view.show()},hide:function(){this.view.hide()},trace:function(a){this.view.trace(this.format(a))},warn:function(a){this.view.warn(this.format(a))},error:function(a){this.view.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return utils.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),db:b("db",{initialize:function(){this.db=null,this.logsData=[];try{window.openDatabase&&(this.db=openDatabase("PlayRTC","1.0","PlayRTC Log Database",20910080),this.db.transaction(function(a){a.executeSql("select * from logs",[],function(){var b="delete from logs where logdate < datetime('now', '-10 day')";a.executeSql(b)},function(a,b){var c="create table if not exists logs (id integer primary key autoincrement,logdate datetime default current_time, log text)";a.executeSql(c)})}))}catch(a){}},trace:function(a){this.save(this.format(a))},warn:function(a){this.save(this.format(a))},error:function(a){this.save(this.format(a))},save:function(a){try{this.db.transaction(function(b){var c="insert into logs(log) values (?)";b.executeSql(c,[a])})}catch(a){}},exportLog:function(){try{this.db.transaction(utils.bind(function(a){var b="select * from logs;";a.executeSql(b,[],utils.bind(function(a,b){for(var c=null,d=0;d<b.rows.length;d++)c=b.rows.item(d),this.logsData.push(c.log+"\r\n");b.rows.length&&this.processEnd()},this))},this))}catch(a){}},processEnd:function(){var a=new Blob(this.logsData,{type:"text/plain"});this.logsData=[],utils.fileDownload(a,this.dateFormat(new Date)+"_log.txt")},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return utils.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g)}}),network:b("network",{initialize:function(){this.config={projectKey:null,interval:6e4},this.storage=window.localStorage,this.q=[]},trace:function(a){Rest.log(this.format(a),function(){})},warn:function(a){Rest.log(this.format(a),function(){})},error:function(a){Rest.log(this.format(a),function(){})},format:function(a){var b=utils.apply({},a);return delete b.klass,delete b.method,delete b.message,delete b.logType,b}})}}(),Call=utils.Extend(utils.Event,{initialize:function(a,b){Call.base.initialize.call(this),this.pid=null,this.token=b.token,this.nagToken=b.nagToken,this.uid=b.uid,this.channelId=b.channelId,this.channelServer=a.channelServer,this.turnInterval=null,
this.healthInterval=null,this.peers={},this.playRtc=a,Logger.trace("cdm",{klass:"Call",method:"initialize",channelId:this.channelId,message:"Created instance of 'Call'"}),this.channeling=new PlayRTC.Channeling(this,this.channelServer),this.channeling.on("onOpen",this.connect,this).on("onConnect",this.onConnect,this).on("onOtherConnect",this.onOtherConnect,this).on("onRing",this.onRing,this).on("onAccept",this.onAccept,this).on("onReject",this.onReject,this).on("onClose",this.onClose,this).on("onOtherClose",this.onOtherClose,this).on("onOtherCloseReconnect",this.onOtherCloseReconnect,this).on("error",this.error,this).on("userCommand",this.onUserCommand,this).on("receiveOfferSdp",this.receiveOfferSdp,this).on("receiveAnwserSdp",this.receiveAnwserSdp,this).on("receiveCandidate",this.receiveCandidate,this)},getChannelId:function(a){return this.channelId},getToken:function(){return this.token},getNagToken:function(){return this.nagToken},getUid:function(a){return this.uid},requestTurn:function(a,b){Logger.trace("cdm",{klass:"Call",method:"requestTurn",channelId:this.getChannelId(),message:"Called requestTurn"});var c=this.playRtc.nagServer+"/webrtcsignaling/v1/"+this.getToken()+"/turnserver?authToken="+this.getNagToken();request({method:"get",url:c,contentType:"application/x-www-form-urlencoded",success:a,error:b})},connect:function(){var a=this.getChannelId();Logger.trace("cdm",{klass:"Call",method:"connect",channelId:a,message:"Token["+this.getToken()+"] UID["+this.getUid()+"] Connected of channel"}),this.channeling.connect(a)},accept:function(a){if(!a)return Logger.error("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"Failed to execute 'accept' on 'Call': 1 arguments required, but only "+arguments.length+" present"}),!1;Logger.trace("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"OtherPID["+a+"] Accepted other peer"}),this.channeling.accept(a);for(attr in this.peers)this.peers[attr].type="answer"},reject:function(a){return a?(Logger.trace("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"OtherPID["+a+"] Rejected other peer"}),delete this.peers[a],void this.channeling.reject(a)):(Logger.error("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"Failed to execute 'reject' on 'Call': 1 arguments required, but only "+arguments.length+" present"}),!1)},ring:function(a){Logger.trace("cdm",{klass:"Call",method:"ring",channelId:this.getChannelId(),message:"OtherPID["+a+"] Sent to ring to other peer"}),this.channeling.ring(a)},createPeer:function(a,b){var c=this.playRtc,d=this.playRtc.getMedia(),e=d?d.getStream():null,f=null;if(this.peers[a]||(this.peers[a]={}),!this.peers[a].peer)return this.peers[a].uid||(this.peers[a].uid=b||""),f={iceServers:c.iceServers,dataChannelEnabled:c.dataChannelEnabled,bandwidth:c.getConfig().bandwidth,preferCodec:c.getConfig().preferCodec,onlyTurn:c.getConfig().onlyTurn},this.peers[a].peer=new Peer(this,a,this.peers[a].uid,e,f),this.peers[a].peer.on("sendOfferSdp",this.sendOfferSdp,this).on("sendAnswerSdp",this.sendAnswerSdp,this).on("sendCandidate",this.sendCandidate,this).on("addRemoteStream",this.addRemoteStream,this).on("signalEnd",this.signalEnd,this).on("error",function(a,b,c){this.fire("error",a,b,c)},this).on("stateChange",this._stateChange,this),this.peers[a]},onConnect:function(a,b){var c=null;Logger.trace("cdm",{klass:"Call",method:"onConnect",channelId:this.getChannelId(),message:"Channel connecting is success"});var d=0,e=b.length;if(this.playRtc.channelType&&("broadcast"===this.playRtc.channelType||"composite"===this.playRtc.channelType)){var f=this.peers.PIDMCU;f||(c=this.createPeer("PIDMCU",a),c.type="offer",c.peer.createOffer())}if(e>0)if(this.playRtc.config.ring)for(;d<e;d++)this.ring(b[d].id);else if(!this.playRtc.channelType||"broadcast"!==this.playRtc.channelType&&"composite"!==this.playRtc.channelType)for(;d<e;d++)c=this.createPeer(b[d].id,b[d].uid),c.type="offer",c.peer.createOffer();else;else this._startTurnInterval();this.channeling.health(),this.healthInterval=window.setInterval(utils.bind(function(){this.channeling.health()},this),3e4)},_startTurnInterval:function(){this.playRtc.config.iceServers||(this.turnInterval=window.setInterval(utils.bind(function(){this.requestTurn(utils.bind(function(a){Logger.trace("cdm",{klass:"Call",method:"onConnect",channelId:this.getChannelId(),message:"Received nag turn server. iceServer = "+JSON.stringify(a)});var b=[{url:"turn:"+a.data.turnserver.turnIp+":"+a.data.turnserver.turnPort,credential:a.data.turnserver.turnPw,username:a.data.turnserver.turnId}];this.playRtc.iceServers=b},this),utils.bind(function(){window.clearInterval(this.turnInterval),this.error("C4011",SDK_ERROR_CODE.C4011)},this))},this),4e4))},onOtherConnect:function(a,b,c){this.turnInterval&&(window.clearInterval(this.turnInterval),this.turnInterval=null);this.playRtc.config.ring||this.peers[a]||(this.peers[a]={},this.peers[a].type="answer",this.peers[a].uid=b,this.peers[a].platformtype=c.env.platformType,this.peers[a].sdktype=c.env.sdk.type,this.peers[a].sdkversion=c.env.sdk.version)},onRing:function(a,b){Logger.trace("cdm",{klass:"Call",method:"onRing",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to ring from other peer"}),this.peers[a]={uid:b},this.playRtc.hasEvent("ring")||(Logger.warn("cdm",{klass:"Data",method:"fileReceive",channelId:this.peer.call.getChannelId(),message:"You must create ring event."}),this.accept(a)),this.playRtc.fire("ring",a,b)},onAccept:function(a,b){Logger.trace("cdm",{klass:"Call",method:"onAccept",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to accept from other peer"});var c=this.createPeer(a,b);c.type="offer",c.peer.createOffer(),this.playRtc.fire("accept",a,b)},onReject:function(a,b){Logger.trace("cdm",{klass:"Call",method:"onReject",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to reject from other peer"}),this.playRtc.fire("reject",a,b)},sendOfferSdp:function(a,b){this.channeling.sendOfferSdp(a,b)},sendAnswerSdp:function(a,b){this.channeling.sendAnswerSdp(a,b)},sendCandidate:function(a,b){this.channeling.sendCandidate(a,b)},receiveOfferSdp:function(a,b,c){var d=this.peers[a],e=null;e=d&&d.peer?d.peer:this.createPeer(a).peer,Logger.trace("cdm",{klass:"Call",method:"receiveOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer offer sdp"}),e.createAnswer(b)},receiveAnwserSdp:function(a,b){if(Logger.trace("cdm",{klass:"Call",method:"receiveAnwserSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer anwser sdp"}),!this.playRtc.channelType||"broadcast"!==this.playRtc.channelType&&"composite"!==this.playRtc.channelType){var c=this.peers[a].peer;c.receiveAnwserSdp(b)}else{var c=this.peers.PIDMCU.peer;c.receiveAnwserSdp(b)}},receiveCandidate:function(a,b,c){var d;!this.playRtc.channelType||"broadcast"!==this.playRtc.channelType&&"composite"!==this.playRtc.channelType?(d=this.peers[a],peer=null):(d=this.peers.PIDMCU,peer=null),d&&d.peer?peer=d.peer:peer=this.createPeer(a).peer,Logger.trace("cdm",{klass:"Call",method:"receiveCandidate",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer candidate"}),peer.receiveCandidate(b)},addRemoteStream:function(a,b,c){this.fire("addRemoteStream",a,b,c)},signalEnd:function(a){},onClose:function(a,b){Logger.trace("cdm",{klass:"Call",method:"onClose",channelId:this.getChannelId(),message:"Disconnected channel"}),this.fire("_disconnectChannel",a,b)},onOtherClose:function(a){var b=this.peers[a],c=null;if(!b)return void this.fire("_otherDisconnectChannel",a);c=b.uid,Logger.trace("cdm",{klass:"Call",method:"onOtherClose",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+c+"] Disconnected with other peer"}),(!this.playRtc.channelType||"broadcast"!==this.playRtc.channelType&&"composite"!==this.playRtc.channelType)&&(b.peer&&b.peer.close(),delete this.peers[a]);var d=0;for(var e in this.peers)d++;d<1&&this._startTurnInterval(),this.fire("_otherDisconnectChannel",a,c)},onOtherCloseReconnect:function(a){var b=this.peers[a],c=null;c=b.uid,Logger.trace("cdm",{klass:"Call",method:"onOtherClose",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+c+"] Disconnected with other peer"}),b.peer&&b.peer.close(),delete this.peers[a];var d=0;for(var e in this.peers)d++},error:function(a,b,c){window.clearInterval(this.healthInterval),window.clearInterval(this.turnInterval),this.healthInterval=null,this.turnInterval=null,this.fire("error",a,b,c)},_stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},destroy:function(){Logger.warn("cdm",{klass:"Call",method:"destroy",channelId:this.getChannelId(),message:"Destroyed instance of 'Call'"}),this.turnInterval&&(window.clearInterval(this.turnInterval),this.turnInterval=null);var a=null,b=this.peers;this.channeling&&this.channeling.socket.close();for(a in b)b[a].peer&&b[a].peer.close();this.peers={},this.healthInterval&&(window.clearInterval(this.healthInterval),this.healthInterval=null)},onUserCommand:function(a,b){this.fire("userCommand",a,b)}});PlayRTC.Channeling=utils.Extend(utils.Event,{initialize:function(a,b){PlayRTC.Channeling.base.initialize.call(this),this.url=b,this.call=a,Logger.trace("cdm",{klass:"Channeling",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'Channeling'"}),this.createSocket()},serialize:function(a){var b={header:{command:"",commandType:"req",token:this.call.getToken(),expireTime:"none",broadcast:"none",sender:{type:"peer",id:"none"},receiver:{type:"server",id:"none"}},body:{}};return JSON.stringify(utils.apply(b,a))},signalSerialize:function(a){var b={header:{command:"",commandType:"req",token:this.call.getToken(),sender:{type:"peer",id:"none"},receiver:{type:"peer",id:"none"}},body:{}};return!this.call.playRtc.channelType||"broadcast"!==this.call.playRtc.channelType&&"composite"!==this.call.playRtc.channelType||(b.header.receiver.type="peer-m",a.header.receiver.type="peer-m",a.header.receiver.id=this.call.getToken(),b.header.receiver.id=this.call.getToken()),JSON.stringify(utils.apply(b,a))},createSocket:function(){Logger.trace("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"WebSocket["+this.url+"] Created instance of 'Channeling Web Socket'"});try{this.socket=new Socket(this.url)}catch(a){return Logger.error("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Failed to create instance of 'Channeling Web Socket'"}),void this.fire("error","C4002",SDK_ERROR_CODE.C4002)}this.socket.on("open",utils.bind(function(a){this.fire("onOpen")},this)).on("close",utils.bind(function(a){Logger.trace("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Closed 'Channeling Web Socket'"})},this)).on("error",utils.bind(function(a){Logger.error("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Caused error 'Channeling Web Socket'"}),this.fire("error","C4007",SDK_ERROR_CODE.C4007)},this)).on("message",this.message,this)},send:function(a){1===this.socket.getReadyState()?this.socket.send(a):(Logger.error("cdm",{klass:"Channeling",method:"send",channelId:this.call.getChannelId(),message:"Already disconnected channel server"}),this.fire("error","C4003",SDK_ERROR_CODE.C4003))},connect:function(a){var b=this.serialize({header:{command:"connect",sender:{env:{platformType:utils.platform,browser:{name:utils.browser.name,version:utils.browser.version},sdk:{type:"web",version:PlayRTC.version},networkType:"wired"}}},body:{data:{uid:this.call.getUid()||"none",channelId:a}}});Logger.trace("cdm",{klass:"Channeling",method:"connect",channelId:this.call.getChannelId(),message:"Sent to connect channel. data = "+b}),this.send(b)},userCommand:function(a,b){var a=this.serialize({header:{command:"userdefined",broadcast:b.length<1?"yes":"no",sender:{id:this.call.getToken()},receiver:{targets:b}},body:{data:{channelId:this.call.getChannelId(),userData:a}}});Logger.trace("cdm",{klass:"Channeling",method:"userCommand",channelId:this.call.getChannelId(),message:"Sent userdefined. data = "+a}),this.send(a)},accept:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",sender:{type:"peer",id:this.call.getToken()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"yes",channelId:this.call.getChannelId(),targetId:a}}});Logger.trace("cdm",{klass:"Channeling",method:"accept",channelId:this.call.getChannelId(),message:"Sent to accept. data = "+b}),this.send(b)},reject:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",sender:{type:"peer",id:this.call.getToken()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"no",channelId:this.call.getChannelId(),targetId:a}}});Logger.trace("cdm",{klass:"Channeling",method:"reject",channelId:this.call.getChannelId(),message:"Sent to reject. data = "+b}),this.send(b)},ring:function(a){var b=this.serialize({header:{command:"ready",sender:{id:this.call.getToken()}},body:{data:{channelId:this.call.getChannelId(),targetId:a}}});Logger.trace("cdm",{klass:"Channeling",method:"ring",channelId:this.call.getChannelId(),message:"Sent to ring. data = "+b}),this.send(b)},disconnectChannel:function(a){var b=this.serialize({header:{command:"peer_close",sender:{id:a}},body:{data:{channelId:this.call.getChannelId()}}});Logger.trace("cdm",{klass:"Channeling",method:"disconnectChannel",channelId:this.call.getChannelId(),message:"Sent to disconnectChannel. data = "+b}),this.send(b)},deleteChannel:function(){var a=this.serialize({header:{command:"channel_close",token:this.call.getToken(),sender:{id:this.call.getToken()}},body:{data:{channelId:this.call.getChannelId()}}});Logger.trace("cdm",{klass:"Channeling",method:"deleteChannel",channelId:this.call.getChannelId(),message:"Sent to delete. data = "+a}),this.send(a)},sendOfferSdp:function(a,b){var c;c=1===this.call.playRtc.create_flag&&this.call.playRtc.channelType&&"broadcast"===this.call.playRtc.channelType?this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getToken()},receiver:{type:"peer",id:a}},body:{data:{create_flag:1,type:"offer",sdp:JSON.stringify(b)}}}):this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getToken()},receiver:{type:"peer",id:a}},body:{data:{type:"offer",sdp:JSON.stringify(b)}}}),Logger.trace("cdm",{klass:"Channeling",method:"sendOfferSdp",channelId:this.call.getChannelId(),message:"Sent offer sdp. data = "+c}),this.send(c)},sendAnswerSdp:function(a,b){var c;c=1===this.call.playRtc.create_flag&&this.call.playRtc.channelType&&"broadcast"===this.call.playRtc.channelType?this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getToken()},receiver:{id:a}},body:{data:{create_flag:1,type:"answer",sdp:JSON.stringify(b)}}}):this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getToken()},receiver:{id:a}},body:{data:{type:"answer",sdp:JSON.stringify(b)}}}),Logger.trace("cdm",{klass:"Channeling",method:"sendAnswerSdp",channelId:this.call.getChannelId(),message:"Sent answer sdp. data = "+c}),this.send(c)},sendCandidate:function(a,b){var c=this.signalSerialize({header:{command:"candidate",sender:{id:this.call.getToken()},receiver:{id:a}},body:{data:{candidate:JSON.stringify(b)}}});Logger.trace("cdm",{klass:"Channeling",method:"sendCandidate",channelId:this.call.getChannelId(),message:"Sent candidate. data = "+c}),this.send(c)},health:function(){var a=this.serialize({header:{command:"health",sender:{},receiver:{}},body:{}});try{this.socket.send(a)}catch(a){Logger.error("cdm",{klass:"Channeling",method:"health",channelId:this.call.getChannelId(),message:"Failed to send health."})}},changeLayoutType:function(a){var b=this.serialize({header:{command:"change_layout",commandType:"req",token:this.call.getToken(),sender:{type:"peer",id:this.call.getToken()},receiver:{type:"peer-m",id:"none"}},body:{data:{channelId:this.call.getChannelId(),layout:a}}});Logger.trace("cdm",{klass:"Channeling",method:"changeLayoutType",channelId:this.call.getChannelId(),message:"Sent to changeLayoutType. data = "+b}),this.send(b)},message:function(message){var data=JSON.parse(message.data),header=data.header,body=data.body,command=header.command.toUpperCase(),others=[],len=0,i=0;if("res"===header.commandType&&"SUCCESS"!==SERVER_CODE[body.header.code])return Logger.error("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received message. data = "+message.data}),void errorDelegate.call(this,"CHANNEL",body.header.code,data);switch(command){case"CONNECT":for(Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'connect'. data = "+message.data}),len=body.data.others.length;i<len;i++)others.push({id:body.data.others[i].id,uid:"none"!==body.data.others[i].uid?body.data.others[i].uid:""});this.fire("onConnect",header.receiver.id,others);break;case"ON_CONNECT":Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'on_connect'. data = "+message.data}),body.data.others.length>0&&this.fire("onOtherConnect",body.data.others[0].id,"none"!==body.data.others[0].uid?body.data.others[0].uid:"",body.data.others[0]);break;case"READY":Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'ring'. data = "+message.data}),body.data.status&&("yes"===body.data.status?this.fire("onAccept",body.data.targetId,"none"!==body.data.uid?body.data.uid:""):this.fire("onReject",body.data.targetId,"none"!==body.data.uid?body.data.uid:""));break;case"ON_READY":Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Rreceived 'on_ring'. data = "+message.data}),this.fire("onRing",body.data.targetId,"none"!==body.data.uid?body.data.uid:"");break;case"CLOSE":Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'close'. data = "+message.data}),this.fire("onClose",body.data.channelId,header.receiver.id);break;case"ON_CLOSE":if(Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_close'. data = "+message.data}),"timeout"===body.data.reason);else if("reconnect"===body.data.reason){var temp=conn.calling.peers,reId=Object.keys(temp),reUid=eval("conn.calling.peers."+reId[0]+".uid"),reSender={env:{platformType:eval("conn.calling.peers."+reId[0]+".platformType"),networkType:"wired",browser:{name:"chrome",version:"56.0.2924.87"},sdk:{type:eval("conn.calling.peers."+reId[0]+".sdktype"),version:eval("conn.calling.peers."+reId[0]+".sdkversion")}}};this.fire("onOtherClose",body.data.targetId),this.fire("onOtherConnect",reId[0],"none"!==reUid?reUid:"",reSender)}else this.fire("onOtherClose",body.data.targetId);break;case"ON_USERDEFINED":Logger.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_userdefined'. data = "+message.data}),this.fire("userCommand",body.data.targetId,body.data.userData);break;case"SDP":if("res"===header.commandType)return;type=body.data.type.toUpperCase(),"OFFER"===type?this.fire("receiveOfferSdp",header.sender.id,JSON.parse(body.data.sdp)):"ANSWER"===type&&this.fire("receiveAnwserSdp",header.sender.id,JSON.parse(body.data.sdp));break;case"CANDIDATE":if("res"===header.commandType)return;this.fire("receiveCandidate",header.sender.id,JSON.parse(body.data.candidate))}}});var Peer=utils.Extend(utils.Event,{initialize:function(a,b,c,d,e){Peer.base.initialize.call(this),this.config=utils.apply({iceServers:null,dataChannelEnabled:!1,bandwidth:{audio:32,video:1500,data:1638400},preferCodec:{audio:"opus",video:"H264"},onlyTurn:!1},e),this.call=a,this.id=b,this.uid=c,this.localStream=d,this.media=null,this.connected=!1,this.oldStats=null,this.statsReportTimer=null,this.peers=this.call.peers[this.id],this.fractionLost=this.call.playRtc.fractionLost||{audio:[{rating:1,fromAflost:0,toAflost:50},{rating:2,fromAflost:51,toAflost:150},{rating:3,fromAflost:151,toAflost:250},{rating:4,fromAflost:251,toAflost:350},{rating:5,fromAflost:351,toAflost:9999999}],video:[{rating:1,fromAflost:0,toAflost:40},{rating:2,fromAflost:41,toAflost:55},{rating:3,fromAflost:56,toAflost:70},{rating:4,fromAflost:71,toAflost:90},{rating:5,fromAflost:91,toAflost:9999999}]},Logger.trace("cdm",{klass:"Peer",method:"initialize",channelId:this.call.getChannelId(),message:"PID["+this.id+"]. Created instance of 'Peer'."})},setEvent:function(){var a=this.pc;a.onicecandidate=utils.bind(function(a){if(Logger.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"Created candidate. candidate = "+JSON.stringify(a.candidate)}),a.candidate){if(this.config.onlyTurn&&a.candidate.candidate.indexOf("relay")<0)return;this.fire("sendCandidate",this.id,a.candidate)}},this),a.onaddstream=utils.bind(function(a){this.media=new Media(a.stream),this.fire("addRemoteStream",this.id,this.uid,a.stream)},this),a.onsignalingstatechange=utils.bind(function(a){this.fire("signalingstatechange",a)},this),a.oniceconnectionstatechange=utils.bind(function(a){this.fire("iceconnectionstatechange",a);var b=a.target.iceConnectionState.toUpperCase(),c=a.target.iceGatheringState.toUpperCase();Logger.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"ConnectionState["+b+"] GatheringState["+c+"] Changed P2P state"}),"COMPLETED"!==b&&"CONNECTED"!==b&&"FAILED"!==b||this.fire("signalEnd",this.id),"FAILED"===b?(this.connected||Logger.error("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",callType:"offer"===this.call.peers[this.id].type?"callee":"caller",resultCode:"400",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.call.playRtc.userMedia.audio?"Y":"N",videoYn:this.call.playRtc.userMedia.video?"Y":"N",message:"PID["+this.call.getToken()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Failed P2P connection"}),this._error("P4001",SDK_ERROR_CODE.P4001)):"CHECKING"===b?(this.fire("stateChange","CHECKING",this.id,this.uid),null===this.error_interval&&(this.error_interval=window.setInterval(utils.bind(function(){this._error("C4012",SDK_ERROR_CODE.C4012),window.clearInterval(this.error_interval),this.error_interval=null,this.close()},this),1e4))):"COMPLETED"===b||"CONNECTED"===b?(Logger.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"PID["+this.call.getToken()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Connected P2P"}),null!==this.error_interval&&(window.clearInterval(this.error_interval),this.error_interval=null),this.connected?Logger.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",resultCode:"202",connectTime:(new Date).getTime(),message:"PID["+this.call.getToken()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Reconnected P2P"}):(this.getStats(utils.bind(function(a){this.oldStats=a;var b;if("firefox"===utils.browser.name){for(attr in a)if("candidatepair"===a[attr].type&&a[attr].selected===!0){b=a[a[attr].localCandidateId].candidateType;break}}else for(var c=0;c<a.length;c++)if("true"===a[c].googActiveConnection){b=a[c].googLocalCandidateType;break}Logger.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",callType:"offer"===this.call.peers[this.id].type?"callee":"caller",resultCode:"200",connectTime:(new Date).getTime(),networkType:"wired",candidate:b,audioYn:this.call.playRtc.userMedia.audio?"Y":"N",videoYn:this.call.playRtc.userMedia.video?"Y":"N",message:"PID["+this.call.getToken()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Connected P2P"})},this)),this.fire("stateChange","SUCCESS",this.id,this.uid)),this.fire("stateChange","CONNECTED",this.id,this.uid),this.connected=!0):"DISCONNECTED"===b?(Logger.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",resultCode:"401",message:"PID["+this.call.getToken()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Disconnected P2P"}),this.fire("stateChange","DISCONNECTED",this.id,this.uid)):"CLOSED"===b&&this.fire("stateChange","CLOSED",this.id,this.uid)},this),a.onremovestream=utils.bind(function(a){this.fire("removestream",a)},this),a.onclose=utils.bind(function(a){this.fire("close",a)},this)},createPeerConnection:function(){Logger.trace("cdm",{klass:"Peer",method:"createPeerConnection",channelId:this.call.getChannelId(),message:"PID["+this.id+"] Created instance of 'Native PeerConnection. Used iceServers = '"+JSON.stringify(this.config.iceServers)}),this.pc=new PeerConnection({iceServers:this.config.iceServers},{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]}),this.setEvent(),this.localStream&&this.pc.addStream(this.localStream),utils.dataChannelSupport&&this.config.dataChannelEnabled?(this.data=new Data(this),this.data.on("open",utils.bind(function(){this.call.playRtc.fire("addDataStream",this.id,this.uid,this.data)},this))):this.config.dataChannelEnabled&&Logger.warn("cdm",{klass:"Peer",method:"createPeerConnection",channelId:this.call.getChannelId(),message:"PID["+this.id+"] Didn't create data channel"})},replaceBandWidth:function(a){if(!this.config.bandwidth)return a;var b=a.match(/a=group:BUNDLE (.*)?\r\n/);if(!b)return a;if(!b[1])return a;b=b[1].split(" ");var c=this.config.bandwidth.audio,d=this.config.bandwidth.video,e=this.config.bandwidth.data,f=new RegExp("a=rtpmap:(\\d+) "+this.config.preferCodec.video+"/(\\d+)");a=a.replace(/b=AS([^\r\n]+\r\n)/g,"");for(var g=0;g<b.length;g++)"audio"===b[g]||"sdparta_0"===b[g]?"opus"===this.config.preferCodec.audio&&(a=a.replace("a=mid:"+b[g]+"\r\n","a=mid:"+b[g]+"\r\nb=AS:"+(c>0?c:32)+"\r\n")):"video"===b[g]||"sdparta_1"===b[g]?(a=a.replace("a=mid:"+b[g]+"\r\n","a=mid:"+b[g]+"\r\nb=AS:"+(d>0?d:1500)+"\r\n"),"chrome"===utils.browser.name&&(a=a.replace(f,"a=rtpmap:$1 "+this.config.preferCodec.video+"/$2\r\na=fmtp:$1 x-google-start-bitrate=600; x-google-min-bitrate=600; x-google-max-bitrate="+(d>0?d:1500)+"; x-google-max-quantization=56"))):"data"!==b[g]&&"sdparta_2"!==b[g]||(a=a.replace("a=mid:"+b[g]+"\r\n","a=mid:"+b[g]+"\r\nb=AS:"+(e>0?e:1638400)+"\r\n"));return a},replacePreferCodec:function(a,b,c){var d,e,f,g=[],h=new RegExp("a=rtpmap:(\\d+) "+c+"/\\d+");if(d=a.match(b),!d)return a;if(e=a.match(h),!e)return a;d=d[0],e=e[1],f=d.split(" "),g.push(f[0]),g.push(f[1]),g.push(f[2]),g.push(e);for(var i=3;i<f.length;i++)f[i]!==e&&g.push(f[i]);return a.replace(d,g.join(" "))},_getConstraints:function(){var a;return a="firefox"===utils.browser.name?{offerToReceiveAudio:this.call.playRtc.userMedia.audio,offerToReceiveVideo:this.call.playRtc.userMedia.video}:{optional:[{VoiceActivityDetection:!1},{DtlsSrtpKeyAgreement:!0}],mandatory:{OfferToReceiveAudio:this.call.playRtc.userMedia.audio,OfferToReceiveVideo:this.call.playRtc.userMedia.video}}},createOffer:function(){this.createPeerConnection(),this.pc.createOffer(utils.bind(function(a){a.sdp=this.replaceBandWidth(a.sdp),a.sdp=this.replacePreferCodec(a.sdp,/m=audio(:?.*)?/,this.config.preferCodec.audio),a.sdp=this.replacePreferCodec(a.sdp,/m=video(:?.*)?/,this.config.preferCodec.video),"broadcast"===this.call.playRtc.channelType&&(1===this.call.playRtc.create_flag?(a.sdp.indexOf("sendrecv")!==-1&&(a.sdp=a.sdp.replace("sendrecv","sendonly")),a.sdp.indexOf("sendrecv")!==-1&&(a.sdp=a.sdp.replace("sendrecv","sendonly"))):(a.sdp.indexOf("sendrecv")!==-1&&(a.sdp=a.sdp.replace("sendrecv","recvonly")),a.sdp.indexOf("sendrecv")!==-1&&(a.sdp=a.sdp.replace("sendrecv","recvonly"))));for(var b=0,c=null,d=a.sdp,e=d,f=e;;){if(b=e.indexOf("a=rtcp-fb"),c=e.indexOf("\r\n",b)+"\r\n".length,b===-1){d!==e&&(a.sdp=a.sdp.replace(d,f));break}var g=e.substring(b,c);f=f.replace(g,""),e=e.substring(c)}Logger.trace("cdm",{klass:"Peer",method:"createOffer",channelId:this.call.getChannelId(),message:"Create offer sdp. offerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendOfferSdp",this.id,a)},this),utils.bind(function(){Logger.error("cdm",{klass:"Peer",method:"createOffer",channelId:this.call.getChannelId(),message:"Failed to create offer sdp"}),this._error("C4008",SDK_ERROR_CODE.C4008)},this),this._getConstraints())},createAnswer:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{b.setRemoteDescription(new NativeRTCSessionDescription(a)),Logger.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set offer sdp. offerSdp = "+JSON.stringify(a)})}catch(a){return Logger.error("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set offer sdp"}),void this._error("C4009",SDK_ERROR_CODE.C4009)}b.createAnswer(utils.bind(function(a){a.sdp=this.replaceBandWidth(a.sdp),a.sdp=this.replacePreferCodec(a.sdp,/m=audio(:?.*)?/,this.config.preferCodec.audio),a.sdp=this.replacePreferCodec(a.sdp,/m=video(:?.*)?/,this.config.preferCodec.video),Logger.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"Created answer sdp. answerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendAnswerSdp",this.id,a)},this),utils.bind(function(a){Logger.error("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"Failed to create answer sdp"}),this._error("C4008",SDK_ERROR_CODE.C4008)},this),this._getConstraints())},receiveAnwserSdp:function(a){var b=this.pc;try{b.setRemoteDescription(new NativeRTCSessionDescription(a)),Logger.trace("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set anwser sdp. anwserSdp = "+JSON.stringify(a)})}catch(a){Logger.error("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set anwser sdp"}),this._error("C4009",SDK_ERROR_CODE.C4009)}},receiveCandidate:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{a=new NativeRTCIceCandidate(a),b.addIceCandidate(a),Logger.trace("cdm",{klass:"Peer",method:"receiveCandidate",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set candidate. candidate = "+JSON.stringify(a)})}catch(a){Logger.error("cdm",{klass:"Peer",method:"receiveCandidate",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set candidate"}),this._error("C4010",SDK_ERROR_CODE.C4010)}},close:function(){this.pc&&this.pc.close(),this.pc=null,this.stopStatsReport()},getDataChannel:function(){return this.data},getMedia:function(){return this.media?this.media:null},getPeerConnection:function(){return this.pc},getStats:function(a){return this.call.playRtc.userMedia.video||this.call.playRtc.userMedia.audio?void("firefox"===utils.browser.name?this.pc.getStats(null,utils.bind(function(b){a.call(this,b)},this),function(){}):this.pc.getStats(utils.bind(function(b){var c=[];b.result().forEach(function(a){var b={};a.names().forEach(function(c){b[c]=a.stat(c)}),b.id=a.id,b.type=a.type,b.timestamp=a.timestamp,c.push(b)}),a.call(this,c)},this))):void a.call(this,!1)},startStatsReport:function(a,b){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null),a<2e3&&(a=2e3),this.statsReportTimer=window.setInterval(utils.bind(function(){this.getStats(utils.bind(function(a){var c,d,e=0,f=0,g=null,h={localCandidate:"",remoteCandidate:"",localFrameWidth:"",localFrameHeight:"",remoteFrameWidth:"",remoteFrameHeight:"",localFrameRate:"",remoteFrameRate:"",availableSendBandwidth:0,availableReceiveBandwidth:0,
rtt:0,rttRating:"",localAudioFractionLost:0,localVideoFractionLost:0,localAudioFractionRating:0,localVideoFractionRating:0,remoteAudioFractionLost:0,remoteVideoFractionLost:0,remoteAudioFractionRating:0,remoteVideoFractionRating:0,fractionRating:0},i=0,j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=this.oldStats;if("firefox"===utils.browser.name){for(g in a)"candidatepair"!==a[g].type||a[g].selected!==!0?"inboundrtp"!==a[g].type||"audio"!==a[g].mediaType||a[g].isRemote!==!0?"inboundrtp"!==a[g].type||"video"!==a[g].mediaType||a[g].isRemote!==!0||(a[g].hasOwnProperty("mozRtt")&&(d=a[g].mozRtt),a[g].hasOwnProperty("packetsLost")&&(r=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(t=a[g].packetsReceived)):(a[g].hasOwnProperty("mozRtt")&&(c=a[g].mozRtt),a[g].hasOwnProperty("packetsLost")&&(q=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(s=a[g].packetsReceived)):(h.localCandidate=a[a[g].localCandidateId].candidateType,h.remoteCandidate=a[a[g].remoteCandidateId].candidateType);for(g in y)"inboundrtp"!==a[g].type||"audio"!==a[g].mediaType||a[g].isRemote!==!0?"inboundrtp"!==a[g].type||"video"!==a[g].mediaType||a[g].isRemote!==!0||(a[g].hasOwnProperty("packetsLost")&&(v=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(x=a[g].packetsReceived)):(a[g].hasOwnProperty("packetsLost")&&(u=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(w=a[g].packetsReceived));this.call.playRtc.userMedia.video?h.rtt=d:h.rtt=c}else{for(f=a.length;e<f;e++)"true"!==a[e].googActiveConnection?a[e].hasOwnProperty("audioInputLevel")?(i=parseInt(a[e].packetsLost),k=parseInt(a[e].packetsSent)):a[e].hasOwnProperty("googFrameWidthSent")?(h.localFrameWidth=parseInt(a[e].googFrameWidthSent),h.localFrameHeight=parseInt(a[e].googFrameHeightSent),h.localFrameRate=parseInt(a[e].googFrameRateSent),j=parseInt(a[e].packetsLost),l=parseInt(a[e].packetsSent)):a[e].hasOwnProperty("audioOutputLevel")?(q=parseInt(a[e].packetsLost),s=parseInt(a[e].packetsReceived)):a[e].hasOwnProperty("googFrameWidthReceived")?(h.remoteFrameWidth=parseInt(a[e].googFrameWidthReceived),h.remoteFrameHeight=parseInt(a[e].googFrameHeightReceived),h.remoteFrameRate=parseInt(a[e].googFrameRateReceived),r=parseInt(a[e].packetsLost),t=parseInt(a[e].packetsReceived)):a[e].hasOwnProperty("googAvailableSendBandwidth")&&(h.availableSendBandwidth=parseInt(a[e].googAvailableSendBandwidth),h.availableReceiveBandwidth=parseInt(a[e].googAvailableReceiveBandwidth)):(h.localCandidate=a[e].googLocalCandidateType,h.remoteCandidate=a[e].googRemoteCandidateType,h.rtt=parseInt(a[e].googRtt));for(e=0;e<y.length;e++)y[e].hasOwnProperty("audioInputLevel")?(m=parseInt(y[e].packetsLost),o=parseInt(y[e].packetsSent)):y[e].hasOwnProperty("googFrameWidthSent")?(n=parseInt(y[e].packetsLost),p=parseInt(y[e].packetsSent)):y[e].hasOwnProperty("audioOutputLevel")?(u=parseInt(y[e].packetsLost),w=parseInt(y[e].packetsReceived)):y[e].hasOwnProperty("googFrameWidthReceived")&&(v=parseInt(y[e].packetsLost),x=parseInt(y[e].packetsReceived))}var z=parseFloat(parseFloat((i-m)/(k-o)*255||0).toFixed(4)),A=parseFloat(parseFloat((j-n)/(l-p)*255||0).toFixed(4));h.localAudioFractionLost=z,h.localVideoFractionLost=A,h.localAudioFractionRating=this._getAFLostRating(z),h.localVideoFractionRating=this._getVFLostRating(A);var B=parseFloat(parseFloat((q-u)/(s-w)*255||0).toFixed(4)),C=parseFloat(parseFloat((r-v)/(t-x)*255||0).toFixed(4));h.remoteAudioFractionLost=B,h.remoteVideoFractionLost=C,h.remoteAudioFractionRating=this._getAFLostRating(B),h.remoteVideoFractionRating=this._getVFLostRating(C),h.fractionRating=h.remoteVideoFractionRating,h.rttRating=this._getRttRating(h.rtt),this.oldStats=a,b&&b.call(this,h)},this))},this),a)},stopStatsReport:function(){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null)},_getRttRating:function(a){var b=0;return a/2>=500?b=5:a/2>=400?b=4:a/2>=300?b=3:a/2>=200?b=2:a/2<200&&(b=1),b},_getAFLostRating:function(a){for(var b=this.fractionLost.audio,c=0;c<b.length;c++)if(b[c].fromFractionLost<=a&&b[c].toFractionLost>=a)return b[c].rating},_getVFLostRating:function(a){for(var b=this.fractionLost.video,c=0;c<b.length;c++)if(b[c].fromFractionLost<=a&&b[c].toFractionLost>=a)return b[c].rating},_error:function(a,b){this.fire("error",a,b,{pid:this.id,uid:this.uid})}}),Media=function(){var a=function(a,b){this.type=b,this.stream=a,this.recordingCb=null,this.stopCb=null,this.mr=new MediaRecorder(this.stream),this.array=[],this.mr.ondataavailable=utils.bind(function(a){this.array.push(a.data),this.recordingCb&&this.recordingCb(a.data)},this),this.mr.onstop=utils.bind(function(a){var b=new Blob(this.array,{type:this.type});this.stopCb&&this.stopCb(b),this.stopCb=null},this)};return a.prototype.start=function(a){this.recordingCb=a,this.mr.start(3e3)},a.prototype.stop=function(a){this.stopCb=a,this.mr.stop()},utils.Extend(utils.Event,{initialize:function(a){Media.base.initialize.call(this),this.stream=a,this.recorder=null},createRecorder:function(){utils.mediaRecorderSupport||Logger.warn("cdm",{klass:"Media",method:"createRecorder",message:"Media Recorder is not suporrted"});var b=null,c=this.getStream();return videoTrack=this.getVideoTrack(),b=videoTrack?new a(c,"video/webm"):new a(c,"audio/ogg; codecs=opus")},record:function(a){return this.recorder?void Logger.error("cdm",{klass:"Media",method:"record",message:"Must call recordStop first"}):(Logger.trace("cdm",{klass:"Media",method:"record",message:"MediaStream Started record"}),this.recorder=this.createRecorder(),void(this.recorder&&this.recorder.start(a)))},recordStop:function(a){return this.recorder?(Logger.trace("cdm",{klass:"Media",method:"recordStop",message:"Stopped record"}),this.recorder.stop(a),void(this.recorder=null)):void Logger.error("cdm",{klass:"Media",method:"recordStop",message:"Failed to execute 'recordStop' on this.recorder is null"})},getStream:function(){return this.stream},getVideoTrack:function(){var a=this.getStream(),b=a.getVideoTracks();return b.length>0?b[0]:null},getAudioTrack:function(){var a=this.getStream(),b=a.getAudioTracks();return b.length>0?b[0]:null},audioMute:function(a){var b=this.getAudioTrack();return!!b&&(b.enabled=a,!0)},videoMute:function(a){var b=this.getVideoTrack();return!!b&&(b.enabled=a,!0)},mute:function(a){this.audioMute(a),this.videoMute(a)},stop:function(){var a=this.getVideoTrack(),b=this.getAudioTrack();a&&a.stop(),b&&b.stop(),this.stream.stop&&this.stream.stop()}})}(),Data=function(){function a(){return(new Date).getTime()}function b(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(new Uint8Array(a),0),c.set(new Uint8Array(b),a.byteLength),c.buffer}if(!utils.blobWorkerSupport)return!1;var c={0:"text",1:"binary"},d={0:"master",1:"frag"},e={},f={};return utils.Extend(utils.Event,{initialize:function(a){Data.base.initialize.call(this),this.peer=a,this.sending=!1,this.queue=[],this.dataChannel=this.peer.getPeerConnection().createDataChannel("channel",{id:1}),this.fileReceiveStartTime=0,this.dataChannel.binaryType="arraybuffer",this.setEvent(),Logger.trace("cdm",{klass:"Data",method:"initialize",message:"PID["+this.peer.id+"]. Created instance of 'Data'"})},setEvent:function(){function a(a){var b=new DataView(a),d=b.getFloat64(0),g=null,h=utils.versionCompare(this.peer.peers.sdkversion,PLATFORM_VERSION[this.peer.peers.platformtype],this.peer.call.playRtc.channelType);g=h===-1?b.getInt32(20):b.getInt32(54);try{e[d]?this.textReceive(d,b,a):f[d]?this.fileReceive(d,b,a):"text"===c[g]?this.textReceive(d,b,a):this.fileReceive(d,b,a)}catch(a){Logger.error("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Failed to receive message"}),this.fire("error",a)}}var b=this.dataChannel;b.onopen=utils.bind(function(a){Logger.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Opened dataChannel"}),this.fire("open",a)},this),b.onclose=utils.bind(function(a){Logger.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Closed dataChannel"}),this.fire("close",a)},this),b.onerror=utils.bind(function(a){Logger.error("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Caused error"}),this.fire("error",a)},this),b.onmessage=utils.bind(function(b){Logger.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Received message"}),a.call(this,b.data)},this)},send:function(a,b,c){a.size&&a.name?(this.sending?this.queue.push({message:a,success:b,error:c}):this.sendFile(a,b,c),this.sending=!0):(a=a.toString(),this.sendText(a,b,c))},bufferedSend:function(a){var b=this.dataChannel;try{b.send(a),Logger.trace("cdm",{klass:"Data",method:"bufferedSend",channelId:this.peer.call.getChannelId(),message:"Sent message"})}catch(a){return Logger.error("cdm",{klass:"Data",method:"bufferedSend",channelId:this.peer.call.getChannelId(),message:"Failed to send dataChannel message error"}),!1}return!0},sendText:function(c,d,e){var f,g,h,i,j=(this.dataChannel,a()),k=this.peer.call.getToken(),l=new ArrayBuffer(20),m=new DataView(l),n=new ArrayBuffer(2*c.length),o=new Uint8Array(n),p=0,q=null,r=c.length,s=0,t=n.byteLength;m.setFloat64(0,j),m.setInt32(8,1);for(var u=utils.bind(function(a,f,g){var h=f[g];return this.fire("sending",{id:j,type:"text",totalSize:t,fragSize:f[g].byteLength,fragCount:i,fragIndex:g}),this.bufferedSend(b(a,h))?void(g+1<f.length?window.setTimeout(function(){var a=g+1;m.setInt32(12,a),m.setInt32(16,f[a].byteLength),u(m.buffer,f,a)},100):d&&d(c)):void(e&&e(c))},this);p<r;p++)q=c.charCodeAt(p),o[s]=q>>>8,o[s+1]=255&q,s+=2;var v=utils.versionCompare(this.peer.peers.sdkversion,PLATFORM_VERSION[this.peer.peers.platformtype],this.peer.call.playRtc.channelType),f=this.packetSplit(n,8192);g=v===-1?new ArrayBuffer(36):new ArrayBuffer(70),h=new DataView(g),i=f.length;var w=0;if(h.setFloat64(w,j),w+=8,h.setInt32(w,0),w+=4,v!==-1){var p=w,s=0;for(w+=34;p<w;p+=2)tmp=k.charCodeAt(s),tmp&&(h.setUint8(p,tmp>>>8),h.setUint8(p+1,255&tmp)),s++}h.setFloat64(w,t),w+=8,h.setInt32(w,0),w+=4,h.setInt32(w,i),w+=4,h.setInt32(w,0),w+=4,h.setInt32(w,f[0].byteLength),u(h.buffer,f,0)},sendFile:function(c,d,e){function f(a){var e=new FileReader,i=0,q=null;i=a+l,e.onload=utils.bind(function(e){if(0===a?q=s.buffer:(n++,y.setInt32(12,n),y.setInt32(16,e.target.result.byteLength),q=y.buffer),m.fire("sending",{id:h,type:"binary",fileName:j,mimeType:k,totalSize:o,fragSize:e.target.result.byteLength,fragCount:p,fragIndex:n}),m.bufferedSend(b(q,e.target.result)),o>a+e.target.result.byteLength)if(0!==g.bufferedAmount)var l=window.setInterval(function(){0===g.bufferedAmount&&(window.clearInterval(l),l=null,f(i))},0);else f(i);else m.sending=!1,d&&d(c),nextData=m.queue.pop(),nextData&&m.send(nextData.message,nextData.success,nextData.error)},this);var r=c.slice(a,i);e.readAsArrayBuffer(r)}var g=this.dataChannel,h=a(),i=this.peer.call.getToken(),j=c.name,k=c.type,l=8192,m=this,n=0,o=c.size,p=Math.ceil(o/l),q=utils.versionCompare(this.peer.peers.sdkversion,PLATFORM_VERSION[this.peer.peers.platformtype],this.peer.call.playRtc.channelType);if(q===-1)var r=new ArrayBuffer(548);else var r=new ArrayBuffer(582);var s=new DataView(r),t=null,u=0;if(s.setFloat64(u,h),u+=8,s.setInt32(u,0),u+=4,q!==-1){var v=u,w=0;for(u+=34;v<u;v+=2)t=i.charCodeAt(w),t&&(s.setUint8(v,t>>>8),s.setUint8(v+1,255&t)),w++}s.setFloat64(u,o),u+=8,s.setInt32(u,1),u+=4;var v=u,w=0;for(u+=256;v<u;v+=2)t=j.charCodeAt(w),t&&(s.setUint8(v,t>>>8),s.setUint8(v+1,255&t)),w++;var v=u,w=0;for(u+=256;v<u;v+=2)t=k.charCodeAt(w),t&&(s.setUint8(v,t>>>8),s.setUint8(v+1,255&t)),w++;s.setInt32(u,p),u+=4,s.setInt32(u,n),u+=4,o<l?s.setInt32(u,o):s.setInt32(u,l);var x=new ArrayBuffer(20),y=new DataView(x);y.setFloat64(0,h),y.setInt32(8,1),f(0)},textReceive:function(a,c,f){var g={},h=null,i=c.getInt32(8);if(g.peerId=this.peer.id,"master"===d[i]){var j=utils.versionCompare(this.peer.peers.sdkversion,PLATFORM_VERSION[this.peer.peers.platformtype],this.peer.call.playRtc.channelType);if(g.id=a,j===-1)g.totalSize=c.getFloat64(12),g.fragCount=c.getInt32(24),g.fragIndex=c.getInt32(28),g.fragSize=c.getInt32(32),h=f.slice(36);else{for(var k="",l=null,m=12;m<46;m+=2)l=String.fromCharCode(c.getInt16(m)),0!==l.charCodeAt(0)&&(k+=l);this.senderId=k,g.totalSize=c.getFloat64(46),g.fragCount=c.getInt32(58),g.fragIndex=c.getInt32(62),g.fragSize=c.getInt32(66),h=f.slice(70)}e[a]=[],e[a].totalSize=g.totalSize,e[a].fragCount=g.fragCount,e[a].push(h)}else g.id=a,g.type="text",g.totalSize=e[a].totalSize,g.fragCount=e[a].fragCount,g.fragIndex=c.getInt32(12),g.fragSize=c.getInt32(16),h=f.slice(20),e[a].push(h);if(j!==-1&&null!==this.senderId&&(g.peerId=this.senderId),this.fire("progress",g),g.fragCount-1===g.fragIndex)try{for(var n=e[a].length,o=e[a],p=new ArrayBuffer(0),q=null,r=[],m=0,s=0;m<n;m++)p=b(p,o[m]);for(m=0,q=new Uint8Array(p),s=p.byteLength;m<s;)r.push((255&q[m++])<<8|255&q[m++]);this.hasEvent("message")||Logger.warn("cdm",{klass:"Data",method:"textReceive",channelId:this.peer.call.getChannelId(),message:"You must create message's event."});var t="";t=j===-1?this.peer.id:this.senderId,this.fire("message",{type:"text",id:a,peerId:t,totalSize:o.totalSize,data:String.fromCharCode.apply(null,r)})}catch(a){Logger.error("cdm",{klass:"Data",method:"textReceive",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Caused error"}),this.fire("error",a)}},fileReceive:function(a,b,c){var e={},g=null,h=b.getInt32(8),j=null,k=null,j=null;if(e.peerId=this.peer.id,"master"===d[h]){var l=utils.versionCompare(this.peer.peers.sdkversion,PLATFORM_VERSION[this.peer.peers.platformtype],this.peer.call.playRtc.channelType);if(l===-1){for(e.totalSize=b.getFloat64(12),e.fileName="",i=24;i<280;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.fileName=e.fileName+k);for(e.mimeType="",i=280;i<536;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.mimeType=e.mimeType+k);e.id=a,e.fragCount=b.getInt32(536),e.fragIndex=b.getInt32(540),e.fragSize=b.getInt32(544),g=c.slice(548)}else{var m="";for(i=12;i<46;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(m+=k);for(this.senderId=m,e.totalSize=b.getFloat64(46),e.fileName="",i=58;i<314;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.fileName=e.fileName+k);for(e.mimeType="",i=314;i<570;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.mimeType=e.mimeType+k);e.id=a,e.fragCount=b.getInt32(570),e.fragIndex=b.getInt32(574),e.fragSize=b.getInt32(578),g=c.slice(582)}f[a]=[],f[a].totalSize=e.totalSize,f[a].fileName=e.fileName,f[a].mimeType=e.mimeType,f[a].fragCount=e.fragCount,f[a].push(g),this.fileReceiveStartTime=(new Date).getTime()}else e.id=a,e.type="binary",e.fileName=f[a].fileName,e.mimeType=f[a].mimeType,e.totalSize=f[a].totalSize,e.fragCount=f[a].fragCount,e.fragIndex=b.getInt32(12),e.fragSize=b.getInt32(16),g=c.slice(20),f[a].push(g);if(l!==-1&&null!==this.senderId&&(e.peerId=this.senderId),this.fire("progress",e),e.fragCount-1===e.fragIndex){try{var j=new Blob(f[a],{type:f[a].mimeType});this.hasEvent("message")||Logger.warn("cdm",{klass:"Data",method:"fileReceive",channelId:this.peer.call.getChannelId(),message:"You must create message's event."});var n="";n=l===-1?this.peer.id:this.senderId,this.fire("message",{type:"binary",id:a,peerId:n,fileName:f[a].fileName,mimeType:f[a].mimeType,totalSize:f[a].totalSize,blob:j}),Logger.trace("cdmn",{klass:"PlayRTC",method:"fileReceive",channelId:this.peer.call.getChannelId(),tokenId:this.peer.call.getToken(),type:"data",callType:"offer"===this.peer.call.peers[this.peer.id].type?"callee":"caller",resultCode:"200",fileRcvSize:f[a].totalSize,fileRcvTime:(new Date).getTime()-this.fileReceiveStartTime,message:"PID["+this.peer.id+"] Succeeded to receive a file. name = "+f[a].fileName}),this.fileReceiveStartTime=0}catch(b){this.fire("error",{type:"binary",id:a,peerId:this.peer.id,fileName:f[a].fileName,mimeType:f[a].mimeType,totalSize:f[a].totalSize}),Logger.error("cdmn",{klass:"PlayRTC",method:"fileReceive",channelId:this.peer.call.getChannelId(),tokenId:this.peer.call.getToken(),type:"data",callType:"offer"===this.peer.call.peers[this.peer.id].type?"callee":"caller",resultCode:"601",fileRcvSize:0,fileRcvTime:0,message:"PID["+this.peer.id+"] Failed to receive a file. name = "+f[a].fileName})}f[a]=null}},packetSplit:function(a,b){for(var c=[],d=b,e=a.byteLength,f=Math.ceil(e/d),g=0;g<f;g++)c.push(a.slice(g*d,(g+1)*d));return c},close:function(){this.dataChannel.close(),this.peer.data=null}})}(),Rest={url:"https://apis.sktelecom.com/v3/playrtc",projectKey:null,setUrl:function(a){this.url=a},setProjectKey:function(a){this.projectKey=a},getProjectKey:function(){return this.projectKey},createChannel:function(a,b,c){var d=this.url+"/channels/channel",e="post";a.nag={userExpires:"86000"},request({body:a,projectKey:this.getProjectKey(),method:e,url:d,success:b,error:c})},connectChannel:function(a,b,c,d){var e=this.url+"/channels/channel/"+a;method="put",b.nag={userExpires:"86000"},request({body:b,projectKey:this.getProjectKey(),method:method,url:e,success:c,error:d})},getChannelList:function(a,b){var c=this.url+"/channels",d="get";request({projectKey:this.getProjectKey(),method:d,url:c,success:a,error:b})},getChannel:function(a,b,c){var d=this.url+"/channels/channel/"+a,e="get";request({projectKey:this.getProjectKey(),method:e,url:d,success:b,error:c})},getPeerList:function(a,b,c){var d=this.url+"/channels/channel/"+a+"/peers",e="get";request({projectKey:this.getProjectKey(),method:e,url:d,success:b,error:c})},getPeer:function(a,b,c,d){var e=this.url+"/channels/channel/"+a+"/peers/peer/"+b,f="get";request({projectKey:this.getProjectKey(),method:f,url:e,success:c,error:d})},searchChannel:function(a,b,c,d){var e=this.url+"/channels/search?f="+a+"&q="+b,f="get";request({projectKey:this.getProjectKey(),method:f,url:e,success:c,error:d})},log:function(a,b){var c=this.url+"/stat",d="put";request({body:a,projectKey:this.getProjectKey(),method:d,url:c,error:b})}};return function(a){Object.defineProperties?Object.defineProperties(a,{version:{get:function(){return"2.2.21"}},activeXversion:{get:function(){return"@@activeXversion"}},utils:{get:function(){return utils}}}):(a.version="2.2.21",a.activeXversion="@@activeXversion",a.utils=utils)}(PlayRTC),PeerConnection&&NativeRTCSessionDescription&&NativeRTCIceCandidate?utils.webRtcSupport=!0:(Logger.warn("cdm",{message:"Your browser is not supported about WebRTC."}),utils.webRtcSupport=!1),utils.dataChannelSupport=function(a){try{var b=new PeerConnection(a,{optional:[{RtpDataChannels:!0}]}),c=!0,d=null;try{d=b.createDataChannel("_support"),d.close()}catch(a){c=!1,Logger.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}}catch(a){c=!1,Logger.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}return c}(),PlayRTC});